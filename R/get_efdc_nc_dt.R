#' @import ncdf4
#' @importFrom ncdf4 nc_open ncvar_get
#' @import data.table
#' @importFrom data.table melt setDT
#' @importFrom stats na.omit
NULL
#' Export grid information to a \code{data.table} from the \code{.nc} file generated by EE.
#' @param filename Character. The name of the \code{.nc} file generated by EE.
#' @param varname Character. The name of the variable to read.
#' @param wetdepth Numeric. The minimum depth of the wet cell.
#' @return A \code{data.table} contains grid coordinates and elevation.
#' @export
get_efdc_nc_dt <- function(filename, varname, wetdepth = 0.15){
  nc <- nc_open(filename)
  # cat(paste("The file has",nc$nvars,"variables: "), names(nc$var))
  # stop if provided a unused varname
  # stopifnot(varname %in% names(nc$var))
  # read grids:
  # longitude at grid center
  lon <- ncvar_get(nc, 'lon')
  # latitude at grid center
  lat <- ncvar_get(nc, 'lat')
  # longitudes of 4 corners of the grid
  lon_bnds <- ncvar_get(nc, 'lon_bnds')
  # longitudes of 4 corners of the grid
  lat_bnds <- ncvar_get(nc, 'lat_bnds')
  lon_melt <- melt(lon, na.rm = T)
  lat_melt <- melt(lat, na.rm = T)
  lon_bnds_melt <- melt(lon_bnds, value.name = 'lon', na.rm = T)
  lat_bnds_melt <- melt(lat_bnds, value.name = 'lat', na.rm = T)
  lon_lat_df <- merge(lon_bnds_melt, lat_bnds_melt, by = c('Var2', 'Var3', 'Var1'))
  setDT(lon_lat_df)
  n_grids <- sum(!is.na(lon))
  lon_lat_df[, id := rep(1:n_grids, each = 4)]
  # merge center corrdinates:
  lon_melt <- melt(lon, value.name = 'clon')
  lat_melt <- melt(lat, value.name = 'clat')
  base_df <- merge(lon_lat_df, lon_melt, by.x = c('Var2', 'Var3'), by.y = c('Var1', 'Var2'))
  base_df <- merge(base_df, lat_melt, by.x = c('Var2', 'Var3'), by.y = c('Var1', 'Var2'))
  # add ZBOT 
  cat('Reading bottom elevation (ZBOT)...\n')
  zbot_df <- ncvar_get(nc, 'ZBOT')
  zbot_df_melt <- melt(zbot_df, value.name = 'ZBOT', na.rm = T)
  base_df <- merge(base_df, zbot_df_melt, by.x = c('Var2', 'Var3'), by.y = c('Var1', 'Var2'), all.y = T)
  # add WSEL to see if the cell is wet or not
  cat('Finish reading bottom elevation (ZBOT)!\n')
  if (varname == 'ZBOT'){
    setDT(base_df)
    return(base_df)
  }
  cat('Reading water surface elevation (WSEL)...\n')
  wsel_df <- ncvar_get(nc, 'WSEL')
  wsel_df_melt <- melt(wsel_df, value.name = 'WSEL', na.rm = T)
  setDT(wsel_df_melt)
  colnames(wsel_df_melt) <- c('Var1', 'Var2', 'Day', 'WSEL')
  base_df <- merge(base_df, wsel_df_melt, by.x = c('Var2', 'Var3'), by.y = c('Var1', 'Var2'), all.y = T, allow.cartesian=TRUE)
  base_df[, WETFLAG := ifelse((WSEL - ZBOT) > wetdepth, 1, NA)]
  base_df <- na.omit(base_df, cols = 'WETFLAG')
  cat('Reading water surface elevation (WSEL)\n', 'Reading variables...\n', sep = '')
  if (varname == 'WSEL') {
    setDT(base_df)
    return(base_df)
  } else{
    # read data
    var_df <- ncvar_get(nc, varname)
    var_df_melt <- melt(var_df, value.name = varname, na.rm = T)
    setDT(var_df_melt)
    colnames(var_df_melt) <- c('Var1', 'Var2', 'Day', varname)
    base_df <- merge(base_df, var_df_melt, by.x = c('Var2', 'Var3', 'Day'), by.y = c('Var1', 'Var2', 'Day'), all.y = T, allow.cartesian=TRUE)
    setDT(base_df)
    base_df <- na.omit(base_df, cols = 'WETFLAG')
    cat('Finish!\n')
    return(base_df)
  }
}
NULL
#' List the variable names in the NetCDF file.
#' @inheritParams efdc_nc_get_grid_dt
#' @export
has_variable <- function(filename){
  nc <- nc_open(filename)
  cat(paste("The file has",nc$nvars,"variables: "), names(nc$var))
}

